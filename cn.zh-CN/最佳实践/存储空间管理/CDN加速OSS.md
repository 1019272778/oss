# CDN加速OSS {#concept_kfw_2dz_5db .concept}

## 背景介绍 {#section_bfr_3dz_5db .section}

传统动静不分离的产品架构，其性能会随着系统访问量的增长而受到限制甚至遭遇瓶颈。产品架构如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/4408/1605_zh-CN.png)

利用CDN和OSS实现动静分离，灵活的架构可以支持海量用户访问。产品架构如下图所示：

![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/4408/1607_zh-CN.png)

## 适用场景 {#section_nyk_tdz_5db .section}

-   静态文件访问量大，服务器负载高，I/O问题导致用户访问卡顿。
-   静态文件数量大，服务器存储空间不够。
-   静态文件用户访问量大，且分布在各地。
-   移动更新包在某个时间段需要高速下载，且并发下载量高。

## 架构描述 {#section_ul4_vdz_5db .section}

OSS作为海量文件存储源，静态图片、视频文件、下载包、app更新包等均放在OSS上。OSS作为CDN的源站，通过CDN加速分发，用户通过CDN节点就近获得文件。架构优势：

-   降低Web服务器负载，静态文件访问负载全部通过CDN。
-   存储费用最低，OSS的存储费用仅为ECS磁盘费用的50%。
-   海量存储空间，无需考虑存储架构升级。
-   流量费用低，相比直接通过OSS访问，除极少额外增加的回源流量外，主要流量使用CDN流量，单价远远低于OSS直接访问的外网流量单价。

## 实战案例 {#section_z5k_wdz_5db .section}

以一个常见的Web站点为例。www.acar.com是一个刚建立的汽车资讯车友交流网站。主站用Php搭建，有10GB的图片素材和部分JS文件。目前购买一台ECS放置所有程序代码，并在ECS上安装MySQL数据库。随着用户访问量的不断增长，不少用户反映，访问网站的速度越来越慢，图片加载慢，网站响应慢。网站技术人员也发现用户上传的图片越来越多，快超过 1TB了。

对于以上案例我们可以利用OSS和CDN对网站进行架构优化，实现动静分离的产品架构，提升用户访问体验，同时成本也在可控的范围内。

解决方案及步骤如下：

1.  对ECS上的网站程序进行整理，把动态程序部分和静态部分分不同的目录进行管理：
    -   建立Images目录，放置所有网站高清素材图片。
    -   建立Javascript目录，放置所有的JS脚本。
    -   建立Attachment目录，放置所有用户上传的图片和附件。
2.  新建一个Bucket。

    根据您的ECS所在的区域选择bucket所在区域，权限选择 公共读，bucket名称与ECS上新建的目录的名称对应，比如“acar-image-bucket”。具体操作请参见 [创建存储空间](../cn.zh-CN/控制台用户指南/管理存储空间/创建存储空间.md#)。

3.  绑定域名**image.acar.com** 并进行CDN加速。具体操作请参见 [管理域名](../cn.zh-CN/控制台用户指南/管理存储空间/管理域名.md#)。
4.  上传文件，体验加速效果。
    1.  把您在第1步中建立在ECS上的Images目录下的所有图片文件上传到**acar-image-bucket**下。具体操作请参见 [上传文件](../cn.zh-CN/控制台用户指南/管理文件/上传文件.md#)。您也可以使用OSS客户端工具更加方便灵活的完成图片的上传。
    2.  获取该文件的CDN加速的访问地址，通常为`您输入的加速域名+'/'+'文件名'`的格式。具体操作请参见 [获取文件访问地址](../cn.zh-CN/控制台用户指南/管理文件/获取文件访问地址.md#)。
    3.  逐一完成图片文件的上传。
5.  按照前4步的示意，把其他两个文件也通过**CDN加速**的方式上传，分别建立**acar-js-bucket**和**acar-csimages-bucket**两个使用CDN加速的OSS bucket。
6.  在原本ECS系统中，找到原本访问静态文件的代码，把访问URL修改为加速访问的地址。以后用户访问您的网站的静态文件就全部通过OSS+CDN的方式访问，不再占用您ECS的资源。

    **说明：** 如果您想把用户上传的文件自动同步到**acar-csimages-bucket**中，您可以参考OSS相关SDK和API的 PutObjcet部分，实现代码级别自动上传。


## CDN缓存自动刷新 {#section_p24_b2z_5db .section}

如果您使用了阿里云的CDN并绑定了加速域名回源到OSS，您就可以使用OSS的CDN缓存自动刷新功能，此功能在覆盖写的情况下（包括覆盖一个已有的文件、删除一个已有的文件），OSS会主动刷新CDN，回源到OSS获取覆盖后的文件，用户不需要显式调用CDN的刷新接口。刷新的URL规则如下：`加速域名 + / + Object`

例如您绑定的加速域名是`image.acar.com`，如果这个域名绑定的bucket覆盖上传了一个文件`test.jpg`，则OSS会刷新掉`image.acar.com/test.jpg`这个URL，刷新生效的时间以CDN保证的刷新生效时间为准，一般在十分钟以内。

开通方法：在Bucket的 域名管理页面，打开 **CDN缓存自动刷新**功能即可。

